version: '3.8'

services:
  # =============================================================================
  # ARIA API Service
  # =============================================================================
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: aria-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - MONGODB_URI=mongodb://mongod:27017/?directConnection=true&replicaSet=rs0
      - MONGODB_DATABASE=aria
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-ollama}
      - EMBEDDING_OLLAMA_MODEL=${EMBEDDING_OLLAMA_MODEL:-qwen3-embedding:0.6b}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1024}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - DEBUG=${DEBUG:-false}
    volumes:
      - aria-data:/app/data
    depends_on:
      mongod:
        condition: service_healthy
      mongot:
        condition: service_started
    networks:
      - aria-network

  # =============================================================================
  # MongoDB Community Server 8.2 (mongod)
  # =============================================================================
  # The main database server. Requires replica set for search features.
  # https://www.mongodb.com/docs/manual/
  mongod:
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    container_name: aria-mongod
    hostname: mongod
    restart: unless-stopped
    command: >
      mongod
      --replSet rs0
      --bind_ip_all
      --port 27017
      --setParameter mongotHost=mongot:27028
    ports:
      - "27017:27017"
    volumes:
      - mongod-data:/data/db
      - mongod-config:/data/configdb
    networks:
      - aria-network
    healthcheck:
      # Initialize replica set on first run, then just check status
      test: >
        mongosh --port 27017 --quiet --eval "
          try {
            rs.status();
          } catch (err) {
            rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'mongod:27017'}]});
          }
        "
      interval: 10s
      timeout: 30s
      start_period: 30s
      retries: 5

  # =============================================================================
  # MongoDB Search Server (mongot)
  # =============================================================================
  # Handles Atlas Search and Vector Search capabilities.
  # Runs alongside mongod and syncs data via change streams.
  # https://www.mongodb.com/docs/atlas/atlas-search/
  mongot:
    image: mongodb/mongodb-community-search:0.53.1
    container_name: aria-mongot
    restart: unless-stopped
    environment:
      # mongot connects to mongod to sync data and receive queries
      - MONGOT_DATA_DIR=/data/mongot
    volumes:
      - mongot-data:/data/mongot
      - ./scripts/mongot-password:/etc/mongot/secrets/passwordFile:ro
    depends_on:
      - mongod
    network_mode: "service:mongod"

  # =============================================================================
  # Replica Set Initializer (one-shot)
  # =============================================================================
  # Ensures replica set is initialized and creates search indexes.
  # Runs once and exits.
  mongo-init:
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    container_name: aria-mongo-init
    depends_on:
      mongod:
        condition: service_healthy
    volumes:
      - ./scripts/init-mongo.js:/scripts/init-mongo.js:ro
    networks:
      - aria-network
    entrypoint: >
      mongosh --host mongod:27017 --quiet /scripts/init-mongo.js
    restart: "no"

volumes:
  aria-data:
  mongod-data:
  mongod-config:
  mongot-data:

networks:
  aria-network:
    driver: bridge
